{% extends "base.html" %}
{% block content %}
  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
      <h3 style="margin:0">Compare: {{ dataset }}</h3>
      <span class="small">A={{ a }} · B={{ b }}</span>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <span class="small">Δ mode:</span>
      <label class="small"><input type="radio" name="mode" value="b_over_a" {% if mode == 'b_over_a' %}checked{% endif %}/> B/A</label>
      <label class="small"><input type="radio" name="mode" value="a_over_b" {% if mode == 'a_over_b' %}checked{% endif %}/> A/B</label>
      <button class="btn" id="swapBtn" type="button">Swap A ↔ B</button>
      <a class="btn" href="{{ download_href }}">下载比较结果 (XLSX)</a>
      <span class="small" style="margin-left:10px;">{{ delta_label }}</span>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
      <div class="card" style="margin:0;">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
          <h4 style="margin:0">Run A</h4>
          <a class="badge" href="/run/{{ dataset | urlencode }}/{{ a | urlencode }}">open</a>
        </div>
        <div class="small" style="margin-top:8px;">{{ meta_a.run_path }}</div>
        <div class="small" style="margin-top:8px;">cpu-bind.txt={{ "yes" if meta_a.has_cpu_bind_file else "no" }}</div>
        <div class="small" style="margin-top:8px;">cores={{ meta_a.cpu_cores if meta_a.cpu_cores is not none else "-" }}</div>
        <div class="small" style="margin-top:8px;">cpu model={{ meta_a.cpu_model if meta_a.cpu_model else "-" }}</div>
        <div class="small" style="margin-top:8px;">CPU bind: <code>{{ meta_a.cpu_bind if meta_a.cpu_bind else "-" }}</code></div>
      </div>

      <div class="card" style="margin:0;">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
          <h4 style="margin:0">Run B</h4>
          <a class="badge" href="/run/{{ dataset | urlencode }}/{{ b | urlencode }}">open</a>
        </div>
        <div class="small" style="margin-top:8px;">{{ meta_b.run_path }}</div>
        <div class="small" style="margin-top:8px;">cpu-bind.txt={{ "yes" if meta_b.has_cpu_bind_file else "no" }}</div>
        <div class="small" style="margin-top:8px;">cores={{ meta_b.cpu_cores if meta_b.cpu_cores is not none else "-" }}</div>
        <div class="small" style="margin-top:8px;">cpu model={{ meta_b.cpu_model if meta_b.cpu_model else "-" }}</div>
        <div class="small" style="margin-top:8px;">CPU bind: <code>{{ meta_b.cpu_bind if meta_b.cpu_bind else "-" }}</code></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
      <h4 style="margin:0">configs/*.json compare</h4>
      <span class="small">(only shows diffs when both sides parse as JSON)</span>
    </div>

    {% if not config_compares or config_compares|length == 0 %}
      <div class="small" style="margin-top:10px;">No config files found under <code>configs/</code> for either run.</div>
    {% else %}
      <div style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>file</th>
              <th>A</th>
              <th>B</th>
              <th>diffs</th>
              <th>details</th>
            </tr>
          </thead>
          <tbody>
            {% for c in config_compares %}
              <tr>
                <td><code>{{ c.name }}</code></td>
                <td class="small">
                  {% if c.present_a %}
                    <a class="badge" href="{{ c.a_href }}">download</a>
                    <span class="small">json={{ 'yes' if c.parse_a_ok else 'no' }}</span>
                  {% else %}
                    <span class="small">missing</span>
                  {% endif %}
                </td>
                <td class="small">
                  {% if c.present_b %}
                    <a class="badge" href="{{ c.b_href }}">download</a>
                    <span class="small">json={{ 'yes' if c.parse_b_ok else 'no' }}</span>
                  {% else %}
                    <span class="small">missing</span>
                  {% endif %}
                </td>
                <td class="small">
                  {% if c.parse_a_ok and c.parse_b_ok %}
                    <span>{{ c.diff_count }}</span>
                    {% if c.flatten_truncated %}<span class="badge">flatten-truncated</span>{% endif %}
                    {% if c.diff_truncated %}<span class="badge">diff-truncated</span>{% endif %}
                  {% else %}
                    <span>-</span>
                  {% endif %}
                </td>
                <td>
                  <details>
                    <summary class="small">view</summary>
                    {% if c.parse_a_ok and c.parse_b_ok %}
                      <div class="small" style="margin-top:8px;">Changed JSON paths (showing up to 200):</div>
                      <table class="mini" style="margin-top:6px;">
                        <thead>
                          <tr>
                            <th>path</th>
                            <th>status</th>
                            <th>A</th>
                            <th>B</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for d in c.diffs %}
                            <tr>
                              <td><code>{{ d.path }}</code></td>
                              <td class="small"><span class="badge">{{ d.status }}</span></td>
                              <td><code title="{{ d.a_full }}">{{ d.a }}</code></td>
                              <td><code title="{{ d.b_full }}">{{ d.b }}</code></td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>

                      <details style="margin-top:10px;">
                        <summary class="small">raw JSON preview</summary>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
                          <div>
                            <div class="small">A</div>
                            <pre style="max-height:320px; overflow:auto; white-space:pre; padding:10px; background:#0f172a0a; border-radius:8px;">{{ c.raw_a if c.raw_a else '' }}</pre>
                          </div>
                          <div>
                            <div class="small">B</div>
                            <pre style="max-height:320px; overflow:auto; white-space:pre; padding:10px; background:#0f172a0a; border-radius:8px;">{{ c.raw_b if c.raw_b else '' }}</pre>
                          </div>
                        </div>
                      </details>
                    {% else %}
                      <div class="small" style="margin-top:8px;">JSON diff unavailable (missing file or parse failed). Raw previews:</div>
                      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px;">
                        <div>
                          <div class="small">A</div>
                          <pre style="max-height:320px; overflow:auto; white-space:pre; padding:10px; background:#0f172a0a; border-radius:8px;">{{ c.raw_a if c.raw_a else '' }}</pre>
                        </div>
                        <div>
                          <div class="small">B</div>
                          <pre style="max-height:320px; overflow:auto; white-space:pre; padding:10px; background:#0f172a0a; border-radius:8px;">{{ c.raw_b if c.raw_b else '' }}</pre>
                        </div>
                      </div>
                    {% endif %}
                  </details>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:baseline;">
      <h4 style="margin:0">summary.tsv compare</h4>
      <span class="small">{{ delta_label }}</span>
    </div>

    <div style="margin-top:10px;">
      <table>
        <thead>
          <tr>
            {% for k in key_fields %}
              <th>{{ k }}</th>
            {% endfor %}
            <th>present</th>
            <th>metrics (A / B / Δ)</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              {% for k in key_fields %}
                <td>{{ r.get(k, "") }}</td>
              {% endfor %}
              <td class="small">{{ ("A" if r.present_a else "-") }} / {{ ("B" if r.present_b else "-") }}</td>
              <td>
                <table class="mini">
                  <thead>
                    <tr>
                      <th>metric</th>
                      <th>A</th>
                      <th>B</th>
                      <th>Δ%</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for m in r.metrics %}
                      <tr>
                        <td>{{ m.name }}</td>
                        <td>{{ m.a }}</td>
                        <td>{{ m.b }}</td>
                        <td><code>{{ m.ratio_pct }}</code></td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="small" style="margin-top:10px;">
      Tips: use browser search; sort/filter coming later.
    </div>
  </div>

  <script>
    (function() {
      const radios = Array.from(document.querySelectorAll('input[name="mode"]'));
      const swapBtn = document.getElementById('swapBtn');
      function selectedMode() {
        const r = radios.find(x => x.checked);
        return r ? r.value : 'b_over_a';
      }
      function navigate(aVal, bVal) {
        const mode = encodeURIComponent(selectedMode());
        const a = encodeURIComponent(aVal);
        const b = encodeURIComponent(bVal);
        window.location.href = `/compare/{{ dataset | urlencode }}?a=${a}&b=${b}&mode=${mode}`;
      }
      const a0 = '{{ a }}';
      const b0 = '{{ b }}';
      radios.forEach(r => r.addEventListener('change', () => navigate(a0, b0)));
      if (swapBtn) {
        swapBtn.addEventListener('click', () => navigate(b0, a0));
      }
    })();
  </script>
{% endblock %}
